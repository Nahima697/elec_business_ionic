<ion-header>
  <ion-toolbar>
    <ion-title>Gérer les disponibilités</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()">
        <ion-icon name="close-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding" color="light">

  <div class="max-w-xl mx-auto space-y-4">
@if (!selectedStationId()) {
    <ion-card class="bg-white m-0 shadow-sm border border-gray-100 rounded-xl">
      <ion-card-content>
        <ion-select
          label="Choisir une borne"
          label-placement="floating"
          [value]="selectedStationId()"
          (ionChange)="selectedStationId.set($event.detail.value)"
          interface="popover"
        >
          @for(station of stationsResource.value(); track station.id) {
            <ion-select-option [value]="station.id">{{ station.name }}</ion-select-option>
          }
        </ion-select>
      </ion-card-content>
    </ion-card>
  }

    @if (selectedStationId()) {

      <ion-card class="bg-white m-0 shadow-sm border border-gray-100 rounded-xl">
        <ion-card-header class="pb-0">
          <ion-card-title class="text-lg font-bold">Ajouter un créneau</ion-card-title>
        </ion-card-header>

        <ion-card-content>
          <form [formGroup]="ruleForm" (ngSubmit)="onSubmit()" class="flex flex-col gap-4 mt-2">

            <ion-select formControlName="dayOfWeek" label="Jour" label-placement="stacked" fill="outline" shape="round">
              <ion-select-option [value]="1">Lundi</ion-select-option>
              <ion-select-option [value]="2">Mardi</ion-select-option>
              <ion-select-option [value]="3">Mercredi</ion-select-option>
              <ion-select-option [value]="4">Jeudi</ion-select-option>
              <ion-select-option [value]="5">Vendredi</ion-select-option>
              <ion-select-option [value]="6">Samedi</ion-select-option>
              <ion-select-option [value]="7">Dimanche</ion-select-option>
            </ion-select>

            <div class="flex gap-2">
              <div class="flex-1">
                <ion-input type="time" label="Début" label-placement="stacked" fill="outline" shape="round" formControlName="startTime"></ion-input>
              </div>
              <div class="flex-1">
                <ion-input type="time" label="Fin" label-placement="stacked" fill="outline" shape="round" formControlName="endTime"></ion-input>
              </div>
            </div>

            <ion-button expand="block" type="submit" [disabled]="ruleForm.invalid" shape="round">
              <ion-icon name="add-circle-outline" slot="start"></ion-icon>
              Ajouter
            </ion-button>
          </form>
        </ion-card-content>
      </ion-card>

      <div class="mt-6">
        <h3 class="text-lg font-bold px-2 mb-2 text-gray-800">Planning actuel</h3>

        @if (rulesResource.isLoading()) {
          <div class="flex justify-center p-6">
            <ion-spinner color="primary"></ion-spinner>
          </div>
        }

        @else if (!rulesResource.value() || rulesResource.value()?.length === 0) {
          <div class="text-center p-8 bg-white rounded-xl border border-dashed border-gray-300 text-gray-500">
            <ion-icon name="calendar-outline" class="text-4xl mb-2 opacity-50"></ion-icon>
            <p>Aucune disponibilité définie pour cette borne.</p>
          </div>
        }

        @else {
          <ion-list class="bg-transparent space-y-2">
            @for(rule of rulesResource.value(); track rule.id) {
              <ion-item lines="none" class="bg-white rounded-xl border border-gray-100 shadow-sm" style="--background: white;">
                <div slot="start" class="bg-blue-50 text-blue-600 p-2 rounded-lg">
                  <ion-icon name="time-outline"></ion-icon>
                </div>

                <ion-label>
                  <h2 class="font-bold text-gray-900">{{ getDayName(rule.dayOfWeek) }}</h2>
                  <p class="text-gray-500">{{ rule.startTime }} - {{ rule.endTime }}</p>
                </ion-label>

                <ion-button slot="end" fill="clear" color="danger" (click)="deleteRule(rule.id!)">
                  <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            }
          </ion-list>
        }
      </div>

    } @else {
      <div class="flex flex-col items-center justify-center h-64 text-center px-6 text-gray-400">
        <ion-icon name="arrow-up-outline" class="text-5xl mb-4 text-blue-200"></ion-icon>
        <h3 class="text-lg font-semibold text-gray-600">Sélectionnez une borne</h3>
        <p class="text-sm">Choisissez une borne ci-dessus pour gérer ses horaires d'ouverture.</p>
      </div>
    }
  </div>
</ion-content>
